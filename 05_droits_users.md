# Gestion utilisateurs et droits

### Exercice 1

Create local user with apikey and login capabilities by updating argocd-cm for username and argocd-secret for password

Create user guest with only login capability
Create user deploy-agent with only apikey capability
Use argocd account command for:
- Listing users 
    `argocd account list`
- Get user details
    `argocd account get --account <name>`
- Set user password
    `argocd account update-password --account <name> --current-password <current-user-password> --new-password <new-user-password>`
    first set:
    `argocd account update-password --account <new-account-name> --current-password <admin-password> --new-password <new-account-password>`
- Generate auth token
    `argocd account generate-token --account <name>`

Create master policy that allows all actions on applications, projects and repositories and assign it to your user.

Create deployer policy that allows to get, override and sync all applications and assign it to deploy-agent user

Check the access rights on argocd UI

### Exercice 2

Use the following model to create argocd project called spring-apps to be deployed on
spring-apps-dev namespace, with all cluster resources and namespace resources allowed,
with readonly role to user 'guest' synconly role to user 'deploy-agent' and manager role to
user 'mahdi'

```yaml
apiVersion: argoproj.io/v1alpha1
kind: AppProject
metadata:
  name: my-project
  namespace: argocd
  # Finalizer that ensures that project is not deleted until it is not referenced by any application
  finalizers:
  - resources-finalizer.argocd.argoproj.io
spec:
  description: Example Project
  # Allow manifests to deploy from any Git repos
  sourceRepos:
  - '*'
  # Only permit applications to deploy to the guestbook namespace in the same cluster
  destinations:
  - namespace: guestbook
    server: https://kubernetes.default.svc
    # Deny all cluster-scoped resources from being created, except for Namespace
  clusterResourceWhitelist:
  - group: ''
    kind: Namespace
  # Allow all namespaced-scoped resources to be created, except for ResourceQuota, LimitRange, NetworkPolicy
  namespaceResourceBlacklist:
  - group: ''
    kind: ResourceQuota
  - group: ''
    kind: LimitRange
  - group: ''
    kind: NetworkPolicy
  # Deny all namespaced-scoped resources from being created, except for Deployment and StatefulSet
  namespaceResourceWhitelist:
  - group: 'apps'
    kind: Deployment
  - group: 'apps'
    kind: StatefulSet
  roles:
  # A role which provides read-only access to all applications in the project
  - name: read-only
    description: Read-only privileges to my-project
    policies:
    - p, proj:my-project:read-only, applications, get, my-project/*, allow
    groups:
    - my-oidc-group
  # A role which provides sync privileges to only the guestbook-dev application, e.g. to provide
  # sync privileges to a CI system
  - name: ci-role
    description: Sync privileges for guestbook-dev
    policies:
    - p, proj:my-project:ci-role, applications, sync, my-project/guestbook-dev, allow
  # NOTE: JWT tokens can only be generated by the API server and the token is not persisted
  # anywhere by Argo CD. It can be prematurely revoked by removing the entry from this list.
    jwtTokens:
    - iat: 1535390316
```

Move demoargo app inside this project
Give guest the permission to synchronize demoargo and test sync
